<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJT Organizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Authentication Check -->
    <script>
        // Inactivity timeout settings (10 minutes)
        const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds
        let inactivityTimer = null;
        let lastActivity = Date.now();
        let isAuthenticated = false;

        // Reset inactivity timer on user activity
        function resetInactivityTimer() {
            if (!isAuthenticated) return; // Only track if authenticated
            
            lastActivity = Date.now();
            
            // Clear existing timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Set new timer
            inactivityTimer = setTimeout(() => {
                console.log('User inactive for 1 minute, logging out...');
                logoutDueToInactivity();
            }, INACTIVITY_TIMEOUT);
        }

        // Logout due to inactivity
        async function logoutDueToInactivity() {
            console.log('Executing logout due to inactivity');
            isAuthenticated = false;
            
            try {
                // Logout on server
                const response = await fetch('api/logout.php', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Logout response:', response.status);
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear storage and redirect
            sessionStorage.clear();
            localStorage.removeItem('currentUser');
            console.log('Redirecting to login');
            window.location.replace('login.html?timeout=1');
        }

        // Track user activity
        function setupActivityTracking() {
            const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
            console.log('Setting up activity tracking for events:', events);
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
        }

        // Check if user is authenticated
        async function checkAuth() {
            try {
                const response = await fetch('api/check_auth.php');
                const result = await response.json();
                
                if (!result.authenticated) {
                    window.location.href = 'login.html';
                    return false;
                }
                
                // Store user info
                window.currentUser = result.user;
                isAuthenticated = true;
                console.log('Current user:', window.currentUser);
                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // Check auth and wait for it to complete before continuing
        checkAuth().then(authenticated => {
            if (authenticated && window.currentUser) {
                console.log('User authenticated, ID:', window.currentUser.id);
                // Start inactivity tracking after successful auth
                setupActivityTracking();
                resetInactivityTimer();
            }
        });
    </script>
    
    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar">
        <!-- Logo -->
        <div class="logo-container">
            <div class="logo-icon" data-icon="briefcase"></div>
            <div class="logo-text">
                <h1>OJT Organizer</h1>
                <p>Internship Hub</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav>
            <button data-page="dashboard" data-icon="dashboard" class="nav-item active">
                <span class="nav-icon"></span>
                <span>Dashboard</span>
            </button>

            <button data-page="tasks" data-icon="tasks" class="nav-item">
                <span class="nav-icon"></span>
                <span>Tasks</span>
            </button>

            <button data-page="progress" data-icon="progress" class="nav-item">
                <span class="nav-icon"></span>
                <span>Progress</span>
            </button>

            <button data-page="timeline" data-icon="timeline" class="nav-item">
                <span class="nav-icon"></span>
                <span>Timeline</span>
            </button>

            <button data-page="documents" data-icon="file" class="nav-item">
                <span class="nav-icon"></span>
                <span>Documents</span>
            </button>

            <button id="usersNavBtn" data-page="users" data-icon="users" class="nav-item" style="display: none;">
                <span class="nav-icon"></span>
                <span>Users</span>
            </button>

            <button data-page="settings" data-icon="settings" class="nav-item">
                <span class="nav-icon"></span>
                <span>Settings</span>
            </button>
            
            <button id="logoutBtn" class="nav-item" style="margin-top: auto; color: #ef4444;">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </span>
                <span>Logout</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main>
        <!-- Header -->
        <header>
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button id="mobileMenuToggle" class="mobile-menu-toggle" style="display: none; background: none; border: none; padding: 8px; cursor: pointer; color: var(--text); z-index: 1000;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div>
                        <h2 id="pageTitle">Dashboard</h2>
                        <p id="pageSubtitle">Welcome back to your OJT journey</p>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-alt); border-radius: 8px; margin-right: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--primary);">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="userDisplay" style="font-size: 14px; font-weight: 600; color: var(--text);"></span>
                    </div>
                    <button id="themeToggle" style="width: 40px; height: 40px; padding: 0; background: var(--bg-alt); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; position: relative; z-index: 100;">
                        <span class="theme-icon" style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; pointer-events: none;"></span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Container -->
        <div class="container" id="pages-container">
            <!-- Pages will be loaded here dynamically -->
        </div>
    </main>

    <!-- Task Modal -->
    <div id="taskModal">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                <h3 id="modalTitle" style="font-size: 18px; font-weight: 700; color: var(--text); margin: 0;">Add Task</h3>
                <button type="button" id="cancelBtn" class="modal-close-btn" style="background: transparent; border: none; cursor: pointer; padding: 4px; color: var(--text-muted); transition: all 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <form id="taskForm" class="task-form" style="display: grid; gap: 18px;">
                <div class="form-section" style="display: grid; gap: 12px;">
                    <h4 class="form-section-title" style="font-size: 12px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.6; margin: 0;">Task Details</h4>
                    
                    <div class="form-group" style="display: grid; gap: 5px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Task Name<span class="required" style="color: #ef4444;">*</span></label>
                        <input type="text" id="taskName" class="form-input" placeholder="Enter task name" required style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; transition: all 0.2s;">
                    </div>

                    <div class="form-group" style="display: grid; gap: 5px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Description</label>
                        <textarea id="taskDescription" class="form-textarea" placeholder="Enter task description" rows="2" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; font-family: inherit; transition: all 0.2s;"></textarea>
                    </div>
                </div>

                <div class="form-section" style="display: grid; gap: 12px;">
                    <h4 class="form-section-title" style="font-size: 12px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.6; margin: 0;">Organization</h4>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group" style="display: grid; gap: 5px;">
                            <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Category<span class="required" style="color: #ef4444;">*</span></label>
                            <select id="taskCategory" class="form-select" required style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; cursor: pointer; transition: all 0.2s;">
                                <option value="">Select category</option>
                                <option value="1">Development</option>
                                <option value="2">Design</option>
                                <option value="3">Testing</option>
                                <option value="4">Documentation</option>
                                <option value="5">Research</option>
                            </select>
                        </div>

                        <div class="form-group" style="display: grid; gap: 5px;">
                            <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Priority<span class="required" style="color: #ef4444;">*</span></label>
                            <select id="taskPriority" class="form-select" required style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; cursor: pointer; transition: all 0.2s;">
                                <option value="">Select priority</option>
                                <option value="1">High</option>
                                <option value="2">Medium</option>
                                <option value="3">Low</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section" style="display: grid; gap: 12px;">
                    <h4 class="form-section-title" style="font-size: 12px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.6; margin: 0;">Schedule & Status</h4>
                    
                    <div class="form-group" style="display: grid; gap: 5px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Due Date</label>
                        <input type="date" id="taskDueDate" class="form-input" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; transition: all 0.2s;">
                    </div>

                    <div class="form-group" style="display: grid; gap: 5px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Date Performed (OJT)</label>
                        <input type="date" id="taskDatePerformed" class="form-input" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; transition: all 0.2s;">
                    </div>

                    <div class="form-group" style="display: grid; gap: 5px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Hours Rendered</label>
                        <input type="number" id="taskHoursRendered" class="form-input" step="0.5" min="0" max="9999" placeholder="e.g., 8.5 or 500" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; transition: all 0.2s;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group" style="display: grid; gap: 5px;">
                            <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Department</label>
                            <input type="text" id="taskDepartment" class="form-input" placeholder="e.g., IT Dept" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; transition: all 0.2s;">
                        </div>
                        <div class="form-group" style="display: grid; gap: 5px;">
                            <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Supervisor</label>
                            <input type="text" id="taskSupervisor" class="form-input" placeholder="e.g., Name" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; transition: all 0.2s;">
                        </div>
                    </div>

                    <div class="form-group" style="display: grid; gap: 5px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Remarks</label>
                        <textarea id="taskRemarks" class="form-input" placeholder="Additional notes..." rows="2" style="padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-alt); color: var(--text); font-size: 13px; font-family: inherit; transition: all 0.2s;"></textarea>
                    </div>

                    <div class="form-group" style="display: grid; gap: 8px;">
                        <label class="form-label" style="font-weight: 600; font-size: 12px; color: var(--text);">Status<span class="required" style="color: #ef4444;">*</span></label>
                        <div class="status-selector" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <button type="button" class="status-btn" data-status="1" aria-label="Pending" style="padding: 8px 10px; background: var(--bg-alt); border: 2px solid var(--border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--text); transition: all 0.2s;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                </svg>
                                <span>Pending</span>
                            </button>
                            <button type="button" class="status-btn" data-status="2" aria-label="In Progress" style="padding: 8px 10px; background: var(--bg-alt); border: 2px solid var(--border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--text); transition: all 0.2s;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                                    <path d="M12 6v6l4 2.5"></path>
                                </svg>
                                <span>Progress</span>
                            </button>
                            <button type="button" class="status-btn" data-status="3" aria-label="Completed" style="padding: 8px 10px; background: var(--bg-alt); border: 2px solid var(--border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--text); transition: all 0.2s;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Done</span>
                            </button>
                        </div>
                        <input type="hidden" id="taskStatus" value="1" required>
                    </div>
                </div>

                <div class="modal-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                    <button type="submit" class="btn btn-primary" style="padding: 10px 18px; background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s;">Save Task</button>
                    <button type="button" id="cancelBtnForm" class="btn btn-secondary" style="padding: 10px 18px; background: var(--bg-alt); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal">
        <div class="delete-modal-content">
            <div class="delete-icon" data-icon="trash"></div>
            <h3 class="delete-title">Delete Task?</h3>
            <p class="delete-message">This action cannot be undone. The task will be permanently removed from your list.</p>
            <div class="delete-buttons">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification"></div>

    <!-- Preview Document Modal -->
    <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-card); border-radius: 16px; max-width: 90%; max-height: 90%; width: 900px; height: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border);">
                <h3 id="previewTitle" style="font-size: 18px; font-weight: 700; color: var(--text); margin: 0;">Document Preview</h3>
                <button type="button" id="closePreviewModal" style="background: transparent; border: none; cursor: pointer; padding: 4px; color: var(--text-muted); transition: all 0.2s;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="previewContent" style="flex: 1; padding: 0; overflow: auto; display: flex; align-items: center; justify-content: center; background: var(--bg-alt);">
                <!-- Preview content will be inserted here -->
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px;">
                <button id="previewDownloadBtn" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                    </svg>
                    Download
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="fabAddTask" class="fab" title="Add New Task">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- Scripts -->
    <script src="js/icons.js"></script>
    <script>
        // Mobile menu toggle functionality
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const pageBody = document.body;

        // Toggle mobile menu
        function toggleMobileMenu() {
            const isOpen = !sidebar.classList.contains('mobile-open');
            if (isOpen) {
                window.scrollTo({ top: 0, behavior: 'auto' });
            }
            sidebar.classList.toggle('mobile-open', isOpen);
            sidebarOverlay.classList.toggle('mobile-open', isOpen);
            pageBody.classList.toggle('mobile-menu-open', isOpen);
        }

        // Close mobile menu
        function closeMobileMenu() {
            sidebar.classList.remove('mobile-open');
            sidebarOverlay.classList.remove('mobile-open');
            pageBody.classList.remove('mobile-menu-open');
        }

        // Mobile menu toggle button click
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        }

        // Close menu when clicking overlay
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeMobileMenu);
        }

        // Close menu when clicking nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', closeMobileMenu);
        });

        // Close menu on window resize if screen becomes large
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });
    </script>
    <script>
        // Inject icons after Icons module loads
        function injectIcons() {
            // Logo icon
            document.querySelectorAll('.logo-icon[data-icon]').forEach(el => {
                el.innerHTML = Icons.render(el.getAttribute('data-icon'));
            });

            // Navigation icons
            document.querySelectorAll('.nav-item[data-icon]').forEach(btn => {
                const icon = btn.querySelector('.nav-icon');
                if (icon) {
                    icon.innerHTML = Icons.render(btn.getAttribute('data-icon'));
                }
            });

            // Delete modal icon
            const deleteIcon = document.querySelector('.delete-icon[data-icon]');
            if (deleteIcon) {
                deleteIcon.innerHTML = Icons.render(deleteIcon.getAttribute('data-icon'));
            }

            // New task button icon
            const newTaskIcon = document.querySelector('.new-task-icon');
            if (newTaskIcon) {
                newTaskIcon.innerHTML = Icons.render('add');
            }

            // Theme toggle icon
            const themeIcon = document.querySelector('.theme-icon');
            if (themeIcon) {
                themeIcon.innerHTML = Icons.render(document.documentElement.classList.contains('dark') ? 'moon' : 'sun');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', injectIcons);
        } else {
            injectIcons();
        }
    </script>
    <script src="js/storage.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/tasks.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/timeline.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/theme.js"></script>
    <script>
        // Setup theme toggle immediately when theme.js is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    if (typeof Theme !== 'undefined') {
                        Theme.toggleTheme();
                        setTimeout(() => Theme.updateThemeIcons(Theme.getCurrentTheme()), 50);
                    }
                });
            }
        });
    </script>
    <script src="js/documents.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Load pages from separate files
        async function loadPages() {
            const pages = [
                { id: 'dashboard-page', file: 'pages/dashboard.html' },
                { id: 'tasks-page', file: 'pages/tasks.html' },
                { id: 'progress-page', file: 'pages/progress.html' },
                { id: 'timeline-page', file: 'pages/timeline.html' },
                { id: 'documents-page', file: 'pages/documents.html' },
                { id: 'users-page', file: 'pages/users.html' },
                { id: 'settings-page', file: 'pages/settings.html' }
            ];

            const container = document.getElementById('pages-container');

            for (const page of pages) {
                try {
                    const response = await fetch(page.file);
                    const html = await response.text();
                    container.insertAdjacentHTML('beforeend', html);
                } catch (error) {
                    console.error(`Error loading ${page.file}:`, error);
                }
            }

            // Set dashboard as active after loading
            const dashboardPage = document.getElementById('dashboard-page');
            if (dashboardPage) {
                dashboardPage.classList.add('active');
            }

            // Initialize app after pages are loaded
            await App.init();
            
            // Initialize documents module
            Documents.init();

            // Initialize admin module if user is admin
            Admin.init();
            
            // Render stats immediately for dashboard
            App.renderStats();
            
            // Initialize theme and update icons
            Theme.init();
            injectIcons();
            
            // Ensure theme icon is correct after all initialization
            setTimeout(() => {
                Theme.updateThemeIcons(Theme.getCurrentTheme());
            }, 200);
            
            // Display current user
            if (window.currentUser) {
                document.getElementById('userDisplay').textContent = window.currentUser.full_name || window.currentUser.username;
            }
        }

        // Load pages when DOM is ready
        document.addEventListener('DOMContentLoaded', loadPages);
        
        // Logout functionality
        document.addEventListener('click', async (e) => {
            if (e.target.closest('#logoutBtn')) {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        const response = await fetch('api/logout.php', {
                            method: 'POST'
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                        window.location.href = 'login.html';
                    }
                }
            }
        });

        // Page Navigation
        function navigateTo(page) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            const targetPage = document.getElementById(page + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }

            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            const navBtn = document.querySelector(`[data-page="${page}"]`);
            if (navBtn) {
                navBtn.classList.add('active');
            }

            const titles = {
                dashboard: { title: 'Dashboard', subtitle: 'Welcome back to your OJT journey' },
                tasks: { title: 'Tasks', subtitle: 'Manage and track your tasks' },
                progress: { title: 'Progress', subtitle: 'View your progress and milestones' },
                timeline: { title: 'Timeline', subtitle: 'See all your activities' },
                documents: { title: 'Documents', subtitle: 'Manage your important files' },
                settings: { title: 'Settings', subtitle: 'Customize your preferences' }
            };

            const info = titles[page];
            if (info) {
                document.getElementById('pageTitle').textContent = info.title;
                document.getElementById('pageSubtitle').textContent = info.subtitle;
            }

            if (page === 'dashboard') App.renderStats();
            if (page === 'tasks') App.renderTasks();
            if (page === 'progress') App.renderProgress();
            if (page === 'timeline') App.renderTimeline();
            if (page === 'documents') Documents.loadDocuments();
                    if (page === 'settings' && typeof Settings !== 'undefined') Settings.init();
        }

        // Export Tasks
        function exportTasks() {
            const tasks = App.state.tasks;
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'tasks-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            UI.showNotification('Tasks exported successfully!', 'success');
        }

        // Clear All Data
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data?\n\nThis will:\n1. Delete all tasks\n2. Clear all settings\n3. Reset the application\n\nThis action CANNOT be undone!')) {
                localStorage.clear();
                App.state.tasks = [];
                App.state.settings = {};
                App.render();
                UI.showNotification('All data cleared! Refreshing...', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // Event Listeners
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => navigateTo(btn.dataset.page));
        });

        // Document filter buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('doc-filter-btn')) {
                document.querySelectorAll('.doc-filter-btn').forEach(b => {
                    b.style.background = 'var(--bg-card)';
                    b.style.color = 'var(--text)';
                    b.style.border = '1px solid var(--border)';
                    b.classList.remove('active');
                });
                e.target.style.background = 'var(--primary)';
                e.target.style.color = 'white';
                e.target.style.border = 'none';
                e.target.classList.add('active');
                
                // Load documents with selected category
                const category = e.target.dataset.category;
                if (typeof Documents !== 'undefined') {
                    Documents.loadDocuments(category);
                }
            }
        });

        // Upload document modal
        document.addEventListener('click', (e) => {
            if (e.target.id === 'uploadDocBtn') {
                const modal = document.getElementById('uploadModal');
                if (modal) modal.style.display = 'flex';
            }
            if (e.target.id === 'closeUploadModal' || e.target.id === 'cancelUploadBtn') {
                const modal = document.getElementById('uploadModal');
                if (modal) modal.style.display = 'none';
                document.getElementById('uploadForm').reset();
            }

            // Preview document
            if (e.target.closest('.doc-preview-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const btn = e.target.closest('.doc-preview-btn');
                console.log('Preview button clicked', btn);
                const filePath = btn.getAttribute('data-path');
                const fileName = btn.getAttribute('data-name');
                const fileExtension = btn.getAttribute('data-extension');
                console.log('Preview data:', { filePath, fileName, fileExtension });
                if (typeof Documents !== 'undefined' && Documents.previewDocument) {
                    Documents.previewDocument(filePath, fileName, fileExtension);
                } else {
                    console.error('Documents.previewDocument not found');
                }
            }

            // Download document
            if (e.target.closest('.doc-download-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const btn = e.target.closest('.doc-download-btn');
                const filePath = btn.getAttribute('data-path');
                const fileName = btn.getAttribute('data-name');
                const link = document.createElement('a');
                link.href = filePath;
                link.download = fileName;
                link.click();
            }

            // Delete document
            if (e.target.closest('.doc-delete-btn')) {
                const btn = e.target.closest('.doc-delete-btn');
                const docId = parseInt(btn.getAttribute('data-id'));
                Documents.deleteDocument(docId);
            }

            // Close preview modal - check for close button or clicking outside
            if (e.target.closest('#closePreviewModal') || e.target.id === 'previewModal') {
                const modal = document.getElementById('previewModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        });

        // Upload form submission
        document.addEventListener('submit', async (e) => {
            if (e.target.id === 'uploadForm') {
                e.preventDefault();
                
                const formData = new FormData();
                formData.append('user_id', App.state.userId);
                formData.append('name', document.getElementById('docName').value);
                formData.append('description', document.getElementById('docDescription').value);
                formData.append('category', document.getElementById('docCategory').value);
                formData.append('file', document.getElementById('docFile').files[0]);
                
                const success = await Documents.uploadDocument(formData);
                
                if (success) {
                    const modal = document.getElementById('uploadModal');
                    if (modal) modal.style.display = 'none';
                    document.getElementById('uploadForm').reset();
                }
            }
        });

        // Floating Action Button (FAB) for adding tasks
        const fabAddTask = document.getElementById('fabAddTask');
        if (fabAddTask) fabAddTask.addEventListener('click', () => App.openAddTaskModal());
        
        const cancelBtn = document.getElementById('cancelBtn');
        if (cancelBtn) cancelBtn.addEventListener('click', () => App.closeTaskModal());
        
        const cancelBtnForm = document.getElementById('cancelBtnForm');
        if (cancelBtnForm) cancelBtnForm.addEventListener('click', () => App.closeTaskModal());
        
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportTasks);
        
        const clearBtn = document.getElementById('clearBtn');
        if (clearBtn) clearBtn.addEventListener('click', clearAllData);

        // Initialize status button handlers
        function initStatusButtons() {
            document.querySelectorAll('.status-btn').forEach(btn => {
                // Remove existing listeners by cloning
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });

            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const status = this.getAttribute('data-status');
                    
                    console.log('Status button clicked:', status);
                    
                    // Update visual state
                    document.querySelectorAll('.status-btn').forEach(b => {
                        b.style.background = 'var(--bg-alt)';
                        b.style.border = '2px solid var(--border)';
                        b.style.color = 'var(--text)';
                    });
                    
                    // Highlight selected button
                    if (status === '1') {
                        this.style.background = 'rgba(245, 158, 11, 0.1)';
                        this.style.border = '2px solid #f59e0b';
                        this.style.color = '#f59e0b';
                    } else if (status === '2') {
                        this.style.background = 'rgba(59, 130, 246, 0.1)';
                        this.style.border = '2px solid #3b82f6';
                        this.style.color = '#3b82f6';
                    } else if (status === '3') {
                        this.style.background = 'rgba(16, 185, 129, 0.1)';
                        this.style.border = '2px solid #10b981';
                        this.style.color = '#10b981';
                    }
                    
                    // Update hidden input
                    document.getElementById('taskStatus').value = status;
                });
            });
        }

        // Call on page load and whenever modal opens
        initStatusButtons();

        // Delete modal handlers
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        if (cancelDeleteBtn) {
            cancelDeleteBtn.addEventListener('click', () => UI.closeModal('deleteModal'));
        }
        
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                const taskId = App.state.deletingTaskId;
                console.log('Delete button clicked, taskId:', taskId);
                if (taskId) {
                    App.deleteTask(taskId);
                }
            });
        }

        // Close modals when clicking outside
        const taskModal = document.getElementById('taskModal');
        if (taskModal) {
            taskModal.addEventListener('click', (e) => {
                if (e.target.id === 'taskModal') {
                    App.closeTaskModal();
                }
            });
        }

        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            deleteModal.addEventListener('click', (e) => {
                if (e.target.id === 'deleteModal') {
                    UI.closeModal('deleteModal');
                }
            });
        }
    </script>
</body>
</html>
